#include <stdio.h>
#include <string.h>
#include "retrossl_rsa.h"
#include "retrossl_inner.h"

int main() {
    printf("Testing RSA encryption debug...\n");
    
    /* Test with a proper RSA modulus (no leading zeros) */
    unsigned char test_n[] = {
        0xC3, 0x5B, 0x1A, 0x8E, 0x72, 0x8F, 0x34, 0x1E, 0x2D, 0x96, 0x3F, 0x47, 0x8A, 0x6E, 0x13, 0x0F,
        0x0F, 0x8E, 0x9A, 0xB4, 0xD7, 0xC5, 0x2F, 0x33, 0x4E, 0xA8, 0xA4, 0x8F, 0x7A, 0x8B, 0x94, 0x7F,
        0x74, 0x5E, 0x1A, 0xD3, 0x3B, 0x8F, 0x4A, 0x8E, 0x72, 0x8F, 0x34, 0x1E, 0x2D, 0x96, 0x3F, 0x47,
        0x8A, 0x6E, 0x13, 0x0F, 0x8E, 0x9A, 0xB4, 0xD7, 0xC5, 0x2F, 0x33, 0x4E, 0xA8, 0xA4, 0x8F, 0x7A,
        0x8B, 0x94, 0x7F, 0x74, 0x5E, 0x1A, 0xD3, 0x3B, 0x8F, 0x4A, 0x8E, 0x72, 0x8F, 0x34, 0x1E, 0x2D,
        0x96, 0x3F, 0x47, 0x8A, 0x6E, 0x13, 0x0F, 0x8E, 0x9A, 0xB4, 0xD7, 0xC5, 0x2F, 0x33, 0x4E, 0xA8,
        0xA4, 0x8F, 0x7A, 0x8B, 0x94, 0x7F, 0x74, 0x5E, 0x1A, 0xD3, 0x3B, 0x8F, 0x4A, 0x8E, 0x72, 0x8F,
        0x34, 0x1E, 0x2D, 0x96, 0x3F, 0x47, 0x8A, 0x6E, 0x13, 0x0F, 0x8E, 0x9A, 0xB4, 0xD7, 0xC5, 0x2F,
        0x33, 0x4E, 0xA8, 0xA4, 0x8F, 0x7A, 0x8B, 0x94, 0x7F, 0x74, 0x5E, 0x1A, 0xD3, 0x3B, 0x8F, 0x4A,
        0x8E, 0x72, 0x8F, 0x34, 0x1E, 0x2D, 0x96, 0x3F, 0x47, 0x8A, 0x6E, 0x13, 0x0F, 0x8E, 0x9A, 0xB4,
        0xD7, 0xC5, 0x2F, 0x33, 0x4E, 0xA8, 0xA4, 0x8F, 0x7A, 0x8B, 0x94, 0x7F, 0x74, 0x5E, 0x1A, 0xD3,
        0x3B, 0x8F, 0x4A, 0x8E, 0x72, 0x8F, 0x34, 0x1E, 0x2D, 0x96, 0x3F, 0x47, 0x8A, 0x6E, 0x13, 0x0F,
        0x8E, 0x9A, 0xB4, 0xD7, 0xC5, 0x2F, 0x33, 0x4E, 0xA8, 0xA4, 0x8F, 0x7A, 0x8B, 0x94, 0x7F, 0x74,
        0x5E, 0x1A, 0xD3, 0x3B, 0x8F, 0x4A, 0x8E, 0x72, 0x8F, 0x34, 0x1E, 0x2D, 0x96, 0x3F, 0x47, 0x8A,
        0x6E, 0x13, 0x0F, 0x8E, 0x9A, 0xB4, 0xD7, 0xC5, 0x2F, 0x33, 0x4E, 0xA8, 0xA4, 0x8F, 0x7A, 0x8B,
        0x94, 0x7F, 0x74, 0x5E, 0x1A, 0xD3, 0x3B, 0x8F, 0x4A, 0x8E, 0x72, 0x8F, 0x34, 0x1E, 0x2D, 0xED
    };
    
    unsigned char test_e[] = {0x01, 0x00, 0x01}; /* 65537 */
    
    br_rsa_public_key pk;
    pk.n = test_n;
    pk.nlen = sizeof(test_n);
    pk.e = test_e;  
    pk.elen = sizeof(test_e);
    
    /* Test input - PKCS#1 padded data (adjusted for 255-byte modulus) */
    unsigned char test_input[255];
    memset(test_input, 0, sizeof(test_input));
    test_input[0] = 0x00;
    test_input[1] = 0x02;
    /* Fill padding with non-zero bytes */
    int i;
    for (i = 2; i < 255 - 48 - 1; i++) {
        test_input[i] = 0x42 + (i % 200) + 1;
    }
    test_input[255 - 48 - 1] = 0x00; /* separator */
    /* Add 48-byte pre-master secret */
    test_input[255 - 48] = 0x03;
    test_input[255 - 47] = 0x01;
    for (i = 255 - 46; i < 255; i++) {
        test_input[i] = 0xAA;
    }
    
    printf("Input data:\n");
    for (i = 0; i < 32; i++) {
        printf("%02x ", test_input[i]);
        if ((i + 1) % 16 == 0) printf("\n");
    }
    printf("...\n");
    
    /* Debug: Check input sizes */
    printf("Modulus size: %zu bytes\n", pk.nlen);
    printf("Exponent size: %zu bytes\n", pk.elen);
    printf("Input size: %zu bytes\n", sizeof(test_input));
    printf("Modulus starts: %02x %02x %02x %02x\n", 
           test_n[0], test_n[1], test_n[2], test_n[3]);
    
    /* Test RSA encryption */
    uint32_t result = br_rsa_i31_public(test_input, sizeof(test_input), &pk);
    
    printf("RSA encryption result: %u\n", result);
    if (result) {
        printf("Encrypted data:\n");
        for (i = 0; i < 32; i++) {
            printf("%02x ", test_input[i]);
            if ((i + 1) % 16 == 0) printf("\n");
        }
        printf("...\n");
    } else {
        printf("RSA encryption failed!\n");
    }
    
    return 0;
}